<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piæœ¯è¯­æŸ¥è¯¢ - æ²™ç›’æ­£å¼ç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { max-width: 600px; margin: 20px auto; padding: 0 20px; }
    h1 { color: #6f42c1; margin-bottom: 20px; }
    .btn { 
      background: #6f42c1; color: white; border: none; 
      padding: 12px 24px; border-radius: 8px; cursor: pointer; 
      font-size: 16px; margin: 10px 0; width: 100%;
      transition: background 0.3s;
    }
    .btn:hover { background: #5a32a3; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .input-box { 
      width: 100%; padding: 12px; border: 1px solid #ddd; 
      border-radius: 8px; margin: 10px 0; font-size: 16px;
    }
    .status { 
      padding: 12px; border-radius: 8px; margin: 10px 0; 
      font-size: 14px; min-height: 20px;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .result { 
      margin-top: 20px; padding: 20px; background: #f8f9fa; 
      border-radius: 8px; border-left: 4px solid #6f42c1;
      display: none;
    }
    .debug-info {
      margin-top: 20px; padding: 10px; background: #f0f0f0;
      border-radius: 5px; font-size: 12px; color: #666;
    }
  </style>
</head>
<body>
  <h1>Piæœ¯è¯­æŸ¥è¯¢ï¼ˆæ²™ç›’æµ‹è¯•ï¼‰</h1>

  <!-- Piè´¦å·æˆæƒæŒ‰é’® -->
  <button id="authBtn" class="btn">ç¬¬ä¸€æ­¥ï¼šæˆæƒPiè´¦å·</button>

  <!-- æœ¯è¯­è¾“å…¥æ¡† -->
  <input 
    type="text" 
    id="termInput" 
    class="input-box" 
    placeholder="è¯·è¾“å…¥è¦æŸ¥è¯¢çš„Piæœ¯è¯­ï¼ˆå¦‚node/miningï¼‰"
    disabled
  >

  <!-- æ”¯ä»˜æŸ¥è¯¢æŒ‰é’® -->
  <button id="payBtn" class="btn" disabled>ç¬¬äºŒæ­¥ï¼šæ”¯ä»˜0.01æµ‹è¯•Piå¹¶æŸ¥è¯¢</button>

  <!-- çŠ¶æ€æç¤ºæ  -->
  <div id="status" class="status"></div>

  <!-- æœ¯è¯­ç»“æœå±•ç¤º -->
  <div id="result" class="result">
    <h3 id="termTitle"></h3>
    <p id="termDesc" style="margin-top: 10px; line-height: 1.6;"></p>
  </div>

  <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ -->
  <div class="debug-info">
    åç«¯çŠ¶æ€: <span id="backendStatus">æœªæ£€æµ‹</span> | 
    æ”¯ä»˜ID: <span id="currentPaymentId">æ— </span>
  </div>

  <!-- å¼•å…¥Piæ²™ç›’SDK -->
  <script src="https://sandbox.minepi.com/pi-sdk.js"></script>
  <script>
    // å…¨å±€å˜é‡
    let piUser = null;
    let currentPayment = null;
    let pollInterval = null;
    
    // ğŸ”¥ é‡è¦ï¼šæ”¹ä¸ºä½ çš„åç«¯åœ°å€
    const API_BASE = "https://chinese-cnbg.vercel.app";
    
    // Piæœ¯è¯­åº“
    const PI_TERMS = {
      "node": "èŠ‚ç‚¹ï¼šPiç½‘ç»œä¸­çš„åˆ†å¸ƒå¼æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œè´Ÿè´£ç»´æŠ¤åŒºå—é“¾çš„å…±è¯†ä¸å®‰å…¨ï¼Œæ˜¯Piç½‘ç»œçš„åŸºç¡€ç»„æˆéƒ¨åˆ†ã€‚",
      "mining": "æŒ–çŸ¿ï¼šåœ¨Piç½‘ç»œä¸­ï¼Œç”¨æˆ·é€šè¿‡è´¡çŒ®é—²ç½®ç®—åŠ›ã€å‚ä¸èŠ‚ç‚¹éªŒè¯ç­‰æ–¹å¼è·å–Piå¸çš„è¿‡ç¨‹ï¼ŒPié‡‡ç”¨è½»é‡çº§æŒ–çŸ¿æœºåˆ¶ï¼Œæ‰‹æœºå³å¯å‚ä¸ã€‚",
      "wallet": "é’±åŒ…ï¼šå­˜å‚¨ã€ç®¡ç†å’Œäº¤æ˜“Piå¸çš„å·¥å…·ï¼Œåˆ†ä¸ºå†·é’±åŒ…ï¼ˆç¦»çº¿ï¼‰å’Œçƒ­é’±åŒ…ï¼ˆåœ¨çº¿ï¼‰ï¼ŒPiå®˜æ–¹é’±åŒ…å†…ç½®åœ¨Appä¸­ã€‚",
      "testnet": "æµ‹è¯•ç½‘ï¼šPiç½‘ç»œçš„æµ‹è¯•ç¯å¢ƒï¼Œç”¨äºå¼€å‘è€…æµ‹è¯•åŠŸèƒ½ã€è°ƒè¯•æ”¯ä»˜æµç¨‹ï¼Œæµ‹è¯•ç½‘Piå¸æ— å®é™…ä»·å€¼ã€‚",
      "consensus": "å…±è¯†ï¼šPiç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹å¯¹åŒºå—é“¾æ•°æ®è¾¾æˆä¸€è‡´çš„æœºåˆ¶ï¼ŒPié‡‡ç”¨æ”¹è¿›çš„Stellarå…±è¯†åè®®ï¼ˆSCPï¼‰ã€‚"
    };

    // DOMå…ƒç´ 
    const authBtn = document.getElementById('authBtn');
    const termInput = document.getElementById('termInput');
    const payBtn = document.getElementById('payBtn');
    const statusBox = document.getElementById('status');
    const resultBox = document.getElementById('result');
    const termTitle = document.getElementById('termTitle');
    const termDesc = document.getElementById('termDesc');
    const backendStatusEl = document.getElementById('backendStatus');
    const paymentIdEl = document.getElementById('currentPaymentId');

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åç«¯
    window.addEventListener('load', async () => {
      try {
        const res = await fetch(`${API_BASE}/api/health`);
        const data = await res.json();
        backendStatusEl.textContent = data.status === 'ok' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
        backendStatusEl.style.color = data.status === 'ok' ? 'green' : 'red';
      } catch (err) {
        backendStatusEl.textContent = 'æ— æ³•è¿æ¥';
        backendStatusEl.style.color = 'red';
      }
    });

    // ========== 1. Piè´¦å·æˆæƒ ==========
    authBtn.addEventListener('click', async () => {
      try {
        authBtn.disabled = true;
        setStatus("loading", "æ­£åœ¨è·³è½¬åˆ°Piæˆæƒé¡µé¢...");

        const authResult = await Pi.authenticateWithPopup({
          scope: ["payments", "username"],
          sandbox: true
        });

        if (authResult && authResult.user) {
          piUser = authResult.user;
          setStatus("success", `æˆæƒæˆåŠŸï¼æ¬¢è¿ ${piUser.username}`);
          termInput.disabled = false;
          payBtn.disabled = false;
          
          // æµ‹è¯•åç«¯è¿æ¥
          const testRes = await fetch(`${API_BASE}/api/health`);
          if (testRes.ok) {
            console.log("åç«¯è¿æ¥æ­£å¸¸");
          }
        } else {
          throw new Error("æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯");
        }
      } catch (err) {
        setStatus("error", `æˆæƒå¤±è´¥ï¼š${err.message}`);
        authBtn.disabled = false;
        console.error("æˆæƒé”™è¯¯:", err);
      }
    });

    // ========== 2. æ”¯ä»˜+æŸ¥è¯¢é€»è¾‘ï¼ˆä¿®æ”¹ç‰ˆï¼‰ ==========
    payBtn.addEventListener('click', async () => {
      const term = termInput.value.trim().toLowerCase();
      
      if (!term) {
        setStatus("error", "è¯·è¾“å…¥è¦æŸ¥è¯¢çš„æœ¯è¯­");
        return;
      }
      if (!PI_TERMS[term]) {
        setStatus("error", `æš‚æœªæ”¶å½•ã€Œ${term}ã€`);
        return;
      }
      if (!piUser || !piUser.uid) {
        setStatus("error", "è¯·å…ˆæˆæƒPiè´¦å·");
        return;
      }

      try {
        payBtn.disabled = true;
        termInput.disabled = true;
        setStatus("loading", "æ­£åœ¨åˆ›å»ºæ”¯ä»˜è®¢å•...");

        // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šè°ƒç”¨è‡ªå·±çš„åç«¯åˆ›å»ºæ”¯ä»˜
        const createRes = await fetch(`${API_BASE}/api/create-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: 0.01,
            memo: `æŸ¥è¯¢Piæœ¯è¯­ï¼š${term}`,
            userUid: piUser.uid,
            metadata: { queryTerm: term }
          })
        });

        const createData = await createRes.json();
        
        if (!createData.success) {
          throw new Error(createData.error || "åˆ›å»ºæ”¯ä»˜å¤±è´¥");
        }

        const payment = createData.payment;
        currentPayment = payment;
        paymentIdEl.textContent = payment.identifier || 'æœªçŸ¥';
        
        setStatus("loading", `æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…æ‰¹å‡†...`);

        // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨æ­£ç¡®çš„ Pi SDK v2.0 API
        setStatus("loading", "è¯·åœ¨å¼¹å‡ºçš„Pié’±åŒ…ä¸­ç¡®è®¤æ”¯ä»˜...");
        
        const piPayment = await Pi.createPayment(
          {
            amount: payment.amount,
            memo: payment.memo,
            metadata: payment.metadata || {}
          },
          {
            onReadyForServerApproval: async (paymentId) => {
              console.log("æ”¯ä»˜å·²åˆ›å»ºï¼Œç­‰å¾…æœåŠ¡å™¨æ‰¹å‡†:", paymentId);
              setStatus("loading", "æ­£åœ¨æ‰¹å‡†æ”¯ä»˜...");
              
              try {
                // è°ƒç”¨åç«¯æ‰¹å‡†æ¥å£
                const approveRes = await fetch(`${API_BASE}/api/approve-payment`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    paymentId: paymentId,
                    amount: payment.amount
                  })
                });
                
                const approveData = await approveRes.json();
                if (!approveData.success) {
                  throw new Error(approveData.error || "æ‰¹å‡†å¤±è´¥");
                }
                
                console.log("æ”¯ä»˜å·²æ‰¹å‡†:", paymentId);
                setStatus("loading", "æ”¯ä»˜å·²æ‰¹å‡†ï¼Œç­‰å¾…å®Œæˆ...");
              } catch (err) {
                console.error("æ‰¹å‡†æ”¯ä»˜å¤±è´¥:", err);
                setStatus("error", `æ‰¹å‡†å¤±è´¥ï¼š${err.message}`);
                resetUI();
                throw err;
              }
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
              console.log("æ”¯ä»˜å·²å®Œæˆï¼Œç­‰å¾…æœåŠ¡å™¨ç¡®è®¤:", paymentId, txid);
              setStatus("loading", "æ­£åœ¨å®Œæˆæ”¯ä»˜...");
              
              try {
                // è°ƒç”¨åç«¯å®Œæˆæ¥å£
                const completeRes = await fetch(`${API_BASE}/api/complete-payment`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    paymentId: paymentId,
                    txid: txid
                  })
                });
                
                const completeData = await completeRes.json();
                if (!completeData.success) {
                  throw new Error(completeData.error || "å®Œæˆå¤±è´¥");
                }
                
                console.log("æ”¯ä»˜å®Œæˆ:", paymentId);
                setStatus("success", "ğŸ‰ æ”¯ä»˜æˆåŠŸï¼");
                showTermResult(term);
                resetUI();
              } catch (err) {
                console.error("å®Œæˆæ”¯ä»˜å¤±è´¥:", err);
                setStatus("error", `å®Œæˆå¤±è´¥ï¼š${err.message}`);
                resetUI();
              }
            },
            onCancel: () => {
              console.log("æ”¯ä»˜å·²å–æ¶ˆ");
              setStatus("error", "æ”¯ä»˜å·²å–æ¶ˆ");
              resetUI();
            },
            onError: (error) => {
              console.error("æ”¯ä»˜é”™è¯¯:", error);
              setStatus("error", `æ”¯ä»˜é”™è¯¯ï¼š${error.message || error}`);
              resetUI();
            }
          }
        );
        
      } catch (err) {
        console.error("æ”¯ä»˜æµç¨‹é”™è¯¯:", err);
        setStatus("error", `æ”¯ä»˜å¤±è´¥ï¼š${err.message}`);
        resetUI();
      }
    });

    // ========== 3. è½®è¯¢æ”¯ä»˜çŠ¶æ€ ==========
    function startPollingPayment(paymentId, term) {
      if (pollInterval) clearInterval(pollInterval);
      
      let attempts = 0;
      const maxAttempts = 120; // 2åˆ†é’Ÿè¶…æ—¶
      
      pollInterval = setInterval(async () => {
        attempts++;
        
        try {
          const res = await fetch(`${API_BASE}/api/payment/${paymentId}`);
          const data = await res.json();
          
          if (!data.success) {
            throw new Error(data.error);
          }
          
          const payment = data.data;
          console.log(`æ”¯ä»˜çŠ¶æ€[${attempts}]:`, payment.status);
          
          // å¤„ç†ä¸åŒçŠ¶æ€
          switch (payment.status) {
            case "approved":
              setStatus("loading", "æ”¯ä»˜å·²æ‰¹å‡†ï¼Œç­‰å¾…å®Œæˆ...");
              break;
              
            case "completed":
              clearInterval(pollInterval);
              setStatus("success", "ğŸ‰ æ”¯ä»˜æˆåŠŸï¼");
              showTermResult(term);
              resetUI();
              break;
              
            case "expired":
              clearInterval(pollInterval);
              setStatus("error", "æ”¯ä»˜è¶…æ—¶ï¼Œè¯·é‡è¯•");
              resetUI();
              break;
              
            case "cancelled":
              clearInterval(pollInterval);
              setStatus("error", "æ”¯ä»˜å·²å–æ¶ˆ");
              resetUI();
              break;
              
            default:
              if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                setStatus("error", "æ”¯ä»˜å¤„ç†è¶…æ—¶");
                resetUI();
              }
          }
        } catch (err) {
          console.error("è½®è¯¢é”™è¯¯:", err);
          if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            setStatus("error", "æŸ¥è¯¢è¶…æ—¶");
            resetUI();
          }
        }
      }, 1000); // æ¯ç§’æŸ¥è¯¢ä¸€æ¬¡
    }

    // ========== è¾…åŠ©å‡½æ•° ==========
    function showTermResult(term) {
      termTitle.textContent = term;
      termDesc.textContent = PI_TERMS[term];
      resultBox.style.display = "block";
      
      // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆå¯é€‰ï¼‰
      if (localStorage) {
        const history = JSON.parse(localStorage.getItem('pi_query_history') || '[]');
        history.unshift({
          term: term,
          time: new Date().toLocaleString(),
          desc: PI_TERMS[term].substring(0, 50) + '...'
        });
        localStorage.setItem('pi_query_history', JSON.stringify(history.slice(0, 10)));
      }
    }

    function resetUI() {
      payBtn.disabled = false;
      termInput.disabled = false;
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      paymentIdEl.textContent = 'æ— ';
    }

    function setStatus(type, text) {
      statusBox.className = `status ${type}`;
      statusBox.textContent = text;
      console.log(`[çŠ¶æ€] ${type}: ${text}`);
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
    });
  </script>
</body>
</html>
