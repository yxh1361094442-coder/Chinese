# Pi Network 支付问题修复说明

## 🔍 发现的问题

经过代码分析，我发现了以下导致支付无法工作的关键问题：

### 问题 1：前端使用了错误的 Pi SDK API ❌

**位置：** `index.html` 第 197-207 行

**原代码（错误）：**
```javascript
const piPayment = window.Pi.createPayment({...});
const paymentResult = await piPayment.showPaymentApproval();
```

**问题：**
- `window.Pi.createPayment()` 和 `showPaymentApproval()` 不是 Pi SDK v2.0 的正确 API
- 这种方式无法正确处理支付回调

**修复：** ✅
- 改用正确的 `Pi.createPayment()` 回调函数方式
- 使用 `onReadyForServerApproval` 和 `onReadyForServerCompletion` 回调

---

### 问题 2：后端缺少完成支付接口 ❌

**位置：** `backend/server.js`

**问题：**
- 前端在支付完成后会调用 `/api/complete-payment` 接口
- 但后端没有实现这个接口，导致支付无法完成

**修复：** ✅
- 已添加完整的 `/api/complete-payment` 接口
- 正确处理交易 ID 和支付完成逻辑

---

### 问题 3：后端批准接口参数处理不完善 ❌

**位置：** `backend/server.js` 第 108-180 行

**问题：**
- `/api/approve-payment` 接口要求必须同时传入 `paymentId` 和 `amount`
- 如果前端只传了 `paymentId`，接口会失败

**修复：** ✅
- 如果缺少 `amount`，自动从缓存中获取
- 如果缓存中也没有，从 Pi API 查询获取
- 支持多种调用方式

---

### 问题 4：私钥签名处理可能失败 ❌

**位置：** `backend/server.js` 签名生成部分

**问题：**
- 私钥格式可能不正确（PEM 格式 vs 原始格式）
- 签名生成失败时没有备用方案

**修复：** ✅
- 自动检测私钥格式
- 如果 PEM 格式失败，尝试原始格式
- 添加了详细的错误处理

---

### 问题 5：Webhook URL 构建可能错误 ❌

**位置：** `backend/server.js` Webhook 回调部分

**问题：**
- 在 Vercel 环境中，`req.headers.host` 可能不包含协议
- 导致内部 API 调用失败

**修复：** ✅
- 使用 `x-forwarded-proto` 头来正确构建完整 URL
- 支持 HTTP 和 HTTPS

---

## ✅ 已修复的代码

### 1. 前端支付流程（index.html）

**修复后的代码：**
```javascript
const piPayment = await Pi.createPayment(
  {
    amount: payment.amount,
    memo: payment.memo,
    metadata: payment.metadata || {}
  },
  {
    onReadyForServerApproval: async (paymentId) => {
      // 调用后端批准接口
      const approveRes = await fetch(`${API_BASE}/api/approve-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          paymentId: paymentId,
          amount: payment.amount
        })
      });
      // ... 处理响应
    },
    onReadyForServerCompletion: async (paymentId, txid) => {
      // 调用后端完成接口
      const completeRes = await fetch(`${API_BASE}/api/complete-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          paymentId: paymentId,
          txid: txid
        })
      });
      // ... 处理响应并显示结果
    },
    onCancel: () => {
      // 处理取消
    },
    onError: (error) => {
      // 处理错误
    }
  }
);
```

### 2. 后端完成支付接口（backend/server.js）

**新增接口：**
```javascript
app.post('/api/complete-payment', async (req, res) => {
  // 处理支付完成逻辑
  // 调用 Pi API 完成支付
  // 更新缓存状态
});
```

### 3. 后端批准接口优化（backend/server.js）

**改进：**
- 自动获取 `amount` 参数（从缓存或 Pi API）
- 改进私钥格式处理
- 添加详细的错误处理

---

## 🚀 下一步操作

### 1. 检查 Vercel 环境变量 ⚠️ 必须

在 Vercel 项目设置中，确保设置了：

```
PI_API_KEY=你的Pi API密钥
PI_APP_PRIV_KEY=你的应用私钥
```

**如何获取：**
1. 登录 [Pi Network 开发者门户](https://develop.pi.network/)
2. 进入你的应用设置
3. 找到 "API Keys" 部分

### 2. 配置 Pi Network 开发者后台 ⚠️ 必须

在 [Pi Network 开发者门户](https://develop.pi.network/) 中：

1. **App Domain（应用域名）**
   - 设置为：`https://chinesepi.vercel.app`

2. **Webhook URL（回调地址）**
   - 设置为：`https://chinese-cnbg.vercel.app/api/pi-webhook`
   - ⚠️ 注意：这是后端地址，不是前端地址！

### 3. 确认代码中的配置

检查以下文件中的配置是否正确：

**backend/server.js:**
```javascript
const APP_SLUG = "chinese-c03891fab800c044";  // 确认这是你的应用 Slug
const APP_DOMAIN = "https://chinesepi.vercel.app";  // 确认这是你的前端域名
```

**index.html:**
```javascript
const API_BASE = "https://chinese-cnbg.vercel.app";  // 确认这是你的后端地址
```

### 4. 重新部署

1. 提交所有代码更改到 Git
2. 在 Vercel 中重新部署
3. 等待部署完成

### 5. 测试

1. 在 Pi Browser 中打开：`https://chinesepi.vercel.app`
2. 点击 "授权Pi账号"
3. 输入术语（如 "node"）
4. 点击 "支付0.01测试Pi并查询"
5. 在 Pi 钱包中确认支付
6. 检查是否成功显示结果

---

## 🔧 如果还有问题

### 检查后端状态

访问：`https://chinese-cnbg.vercel.app/api/health`

应该返回：
```json
{
  "status": "ok",
  "environment": "sandbox",
  "hasConfig": true,
  "appSlug": "chinese-c03891fab800c044",
  "domain": "https://chinesepi.vercel.app"
}
```

如果 `hasConfig` 是 `false`，说明环境变量未设置。

### 查看日志

在 Vercel Dashboard 中：
1. 进入你的项目
2. 点击 "Deployments"
3. 点击最新的部署
4. 点击 "Functions" 标签
5. 查看 `backend/server.js` 的日志

### 常见错误

1. **"签名生成失败"**
   - 检查 `PI_APP_PRIV_KEY` 是否正确设置
   - 确认私钥格式（可能需要包含 PEM 头尾）

2. **"支付创建失败"**
   - 检查 `PI_API_KEY` 是否正确
   - 确认 `APP_SLUG` 是否正确
   - 检查 Pi Network 开发者后台的配置

3. **"Webhook 未收到"**
   - 确认 Webhook URL 配置正确
   - 确认 URL 是公开可访问的 HTTPS 地址
   - 检查 Vercel 函数日志

---

## 📝 需要你提供的信息

如果问题仍然存在，请提供：

1. **Vercel 环境变量截图**（隐藏敏感信息）
   - 确认 `PI_API_KEY` 和 `PI_APP_PRIV_KEY` 已设置

2. **Pi Network 开发者后台配置截图**（隐藏敏感信息）
   - App Domain
   - Webhook URL
   - App Slug

3. **后端健康检查结果**
   - 访问 `https://chinese-cnbg.vercel.app/api/health` 的返回结果

4. **Vercel 部署日志**
   - 特别是错误信息

5. **浏览器控制台错误**（在 Pi Browser 中）
   - 打开开发者工具查看 Console 和 Network

6. **具体的错误信息**
   - 支付在哪一步失败？
   - 显示的错误消息是什么？

---

## 📚 相关文档

- [Pi Network 开发者文档](https://develop.pi.network/)
- [Pi SDK 文档](https://github.com/pi-apps/pi-platform-docs)
- [Vercel 部署文档](https://vercel.com/docs)

---

祝部署顺利！如果还有问题，请提供上述信息，我会继续帮你排查。🎉

